<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>流体光感生成器 v5.1 (移动端交互版)</title>
  <script src="https://cdn.tailwindcss.com"></script>

<style>
    :root {
        --bg-color: #f5f5f7;
        --text-color: #1d1d1f;
        --panel-bg: rgba(255, 255, 255, 0.9);
        --panel-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        
        /* 鼠标视差变量 */
        --mx: 0;
        --my: 0;
        
        /* 默认球体大小 */
        --blob-size: 115px;
    }

    body.dark-mode  {
        --bg-color: #050505;
        --text-color: #f0f0f0;
        --panel-bg: rgba(30, 30, 30, 0.9);
        --panel-shadow: 0 -10px 40px rgba(0,0,0,0.6);
    }
    
    body.dark-mode .text-display-optimized {
        color: white !important;
    }

    body {
        background: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 35px;
        font-family: 'SF Pro Display', system-ui, -apple-system, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: background 0.5s ease, color 0.5s ease;
        min-height: 100vh;
        overflow-x: hidden;
        /* 防止移动端下拉刷新影响拖拽体验 */
        overscroll-behavior-y: none; 
    }

    /* === 顶部标题区域 === */
    header {
        position: relative;
        z-index: 10;
        margin-bottom: 20px;
    }

    /* === 网格布局 === */
    .grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 30px;
        max-width: 1000px;
        width: 100%;
        justify-items: center;
        /* 底部留白，防止被控制面板遮挡 */
        padding-bottom: 180px; 
        perspective: 1000px;
    }

    @media (min-width: 640px) {
        .grid { grid-template-columns: repeat(3, 1fr); padding-bottom: 160px; }
    }
    @media (min-width: 768px) {
        .grid { grid-template-columns: repeat(4, 1fr); }
    }
    @media (max-width: 639px) {
        :root { --blob-size: 150px; }
        .grid { 
            grid-template-columns: repeat(2, 1fr) !important; 
            gap: 20px; 
            padding: 0 10px 200px; /* 增加底部留白 */
        }
        
        /* 标题适配 */
        #title-display { font-size: 1.6rem; letter-spacing: -1.3px; }
        #text-display { font-size: 0.9rem;  letter-spacing: -0.3px; }
    }
    

    /* === 核心球体样式 === */
    .blob {
        width: var(--blob-size);
        height: var(--blob-size);
        border-radius: 50%;
        background-size: 200% 200%;
        position: relative;
        cursor: pointer; 
        transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), width 0.2s, height 0.2s;
        filter: blur(1px) contrast(1.5);
        box-shadow: 
            inset calc(var(--mx) * -20px) calc(var(--my) * -20px) 30px rgba(255,255,255,0.6), 
            inset calc(var(--mx) * 20px) calc(var(--my) * 20px) 30px rgba(0,0,0,0.15),
            0 15px 35px rgba(0,0,0,0.15);
        
        /* 禁用触摸时的默认高亮 */
        -webkit-tap-highlight-color: transparent;
    }

    .blob:hover {
        transform: scale(1.05) translateY(-5px);
        z-index: 10;
    }
    .blob:active {
        transform: scale(0.95);
    }

    /* 噪点纹理 */
    .blob::after {
        content: "";
        position: absolute;
        inset: -10%;
        width: 100%; height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.15'/%3E%3C/svg%3E");
        opacity: 0.2;
        mix-blend-mode: overlay;
        pointer-events: none;
        animation: noiseMove 4s steps(10) infinite;
    }

    /* === 弥散模式 === */
    .grid.diffusion-active .blob {
        filter: blur(1.5px) contrast(2);
        box-shadow: none; 
    }
    .grid.diffusion-active .blob::after { opacity: 0.1; }

    @keyframes spin { 
        0% { transform: rotate(0deg); } 
        100% { transform: rotate(360deg); } 
    }

    /* === 控制面板 (基础样式) === */
    .controls {
        position: fixed;
        bottom: 20px;
        background: var(--panel-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 18px 24px;
        border-radius: 24px;
        box-shadow: var(--panel-shadow);
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: center;
        z-index: 100;
        border: 1px solid rgba(128,128,128,0.15);
        max-width: 95%;
        justify-content: center;
        transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    /* 拖拽手柄 - 默认隐藏 (桌面端) */
    .drag-handle-area {
        display: none;
    }

    /* === 移动端底部抽屉样式 (核心逻辑) === */
    @media (max-width: 639px) {
        .controls {
            /* 贴底布局 */
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 100%;
            width: 100%;
            border-radius: 28px 28px 0 0;
            padding: 0 24px 0px 24px; /* 底部增加 padding 适配 iPhone Home 条 */
            border: none;
            border-top: 1px solid rgba(255,255,255,0.2);
            
            /* 布局改为纵向 */
            flex-direction: column;
            align-items: stretch;
            gap: 15px;

            /* 初始状态：向下偏移，只留出顶部 40px */
            /* 使用 JS 动态计算更准确，这里作为兜底 */
            transform: translateY(calc(100% - 44px)); 
            
            /* 提升层级 */
            z-index: 999;
        }

        /* 拖拽手柄区域 */
        .drag-handle-area {
            display: flex;
            width: 100%;
            height: 44px; /* 点击/拖拽区域高度 */
            justify-content: center;
            align-items: center;
            cursor: grab;
            margin-bottom: 5px;
            flex-shrink: 0;
            /* 增加触摸热区 */
            margin-top: -10px;
            padding-top: 10px;
        }

        /* 视觉上的灰色短横线 */
        .drag-pill {
            width: 36px;
            height: 5px;
            background-color: rgba(128, 128, 128, 0.3);
            border-radius: 10px;
            pointer-events: none;
        }

        /* 内部元素适配 */
        .control-item {
            width: 100%;
            flex-direction: row; /* 手机上尽量让 label 和 input 在一行 */
            justify-content: space-between;
            align-items: center;
        }
        
        /* 特殊处理颜色选择器 */
        .control-item:first-of-type {
            flex-direction: column;
            align-items: flex-start;
        }
        .control-item:first-of-type .color-group {
            width: 100%;
            justify-content: flex-start;
            margin-top: 8px;
        }

        .toggle-group {
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
        }

        button {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            margin-top: 10px;
        }
    }

    /* 通用控件样式 */
    .control-item label {
        font-size: 0.8rem;
        font-weight: 600;
        opacity: 0.7;
        letter-spacing: 0.5px;
    }

    .color-group { display: flex; gap: 12px; align-items: center; }
    
    .color-input-wrapper { 
        display: flex;           /* 关键：开启弹性布局 */
        align-items: center;     /* 关键：让内部的颜色球垂直居中 */
        transition: 0.3s; overflow: hidden; 
    
    }
    .color-input-wrapper.hidden { width: 0; opacity: 0; margin: 0;}
    
    input[type="color"] {
        border: none; background: none; height: 40px; width: 40px;
        border-radius: 50%; cursor: pointer; padding: 0;
        /* 增加圆角遮罩，适配 Webkit */
        -webkit-appearance: none;
    }
    input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; border: 2px solid rgba(0,0,0,0.1); }

    input[type="range"] {
        width: 115px;
        accent-color: var(--text-color);
    }
    @media (max-width: 639px) { input[type="range"] { width: 50%; } }

    .toggle-switch { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; font-weight: 600; }
    
    button {
        padding: 12px 24px;
        border-radius: 14px;
        background: var(--text-color);
        color: var(--bg-color);
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s;
    }
    button:active { transform: scale(0.96); }

    /* Toast */
    #toast {
        position: fixed;
        top: 30px; left: 50%; transform: translateX(-50%) translateY(-20px);
        background: rgba(0,0,0,0.8); color: white;
        padding: 12px 24px; border-radius: 50px;
        font-size: 0.9rem; opacity: 0; pointer-events: none;
        transition: 0.3s; z-index: 200; backdrop-filter: blur(5px);
    }
    #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
</style>
</head>
<body>

<header id="gradient-display" class="flex flex-col items-center justify-center p-3">
    <div id="title-display" class="text-black text-2xl md:text-4xl font-bold tracking-wider transition-opacity duration-500 text-display-optimized">
    Fluid Orbs-光溯
    </div>
  <div id="text-display" class="subtitle text-black text-sm md:text-sm font-bold tracking-wider transition-opacity duration-500 text-display-optimized mt-1">
    @Kaimana
  </div>
</header>

<div class="grid" id="grid"></div>

<div id="toast">✅ CSS 已复制</div>

<!-- 控制面板 -->
<div class="controls" id="controlPanel">
    <!-- 移动端拖拽把手 -->
    <div class="drag-handle-area" id="dragHandle">
        <div class="drag-pill"></div>
    </div>
    
    <!-- 1. 颜色控制 -->
    <div class="control-item">
        <div style="display:flex; justify-content:space-between; width:100%;">
            <label>配色方案</label>
            <label class="toggle-switch" style="font-size: 0.75rem;">
                <input type="checkbox" id="dualColorToggle"> 双色模式
            </label>
        </div>
        <div class="color-group">
            <input type="color" id="colorPicker1" value="#4477ff">
            <div class="color-input-wrapper hidden" id="colorInput2Wrapper">
                <input type="color" id="colorPicker2" value="#ff44aa">
            </div>
        </div>
    </div>

    <!-- 2. 偏差控制 -->
    <div class="control-item">
        <label>色彩偏差</label>
        <input type="range" id="varianceRange" min="0" max="100" value="55">
    </div>

    <!-- 3. 大小控制 -->
    <div class="control-item">
        <label>大小 <span id="sizeVal" style="font-family:monospace; margin-left:5px; opacity:0.6;">115px</span></label>
        <input type="range" id="sizeRange" min="90" max="250" value="115">
    </div>

    <!-- 4. 开关组 -->
    <div class="toggle-group">
        <label class="toggle-switch">
            <input type="checkbox" id="diffusionToggle">
            弥散模式
        </label>
        <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle">
            深色背景
        </label>
    </div>

    <button onclick="regenerate()">✨ 重新生成</button>
</div>

<!-- 遮罩层 (移动端展开时显示) -->
<div id="backdrop" style="position:fixed; inset:0; background:rgba(0,0,0,0.3); z-index:90; opacity:0; pointer-events:none; transition:opacity 0.3s;"></div>

<script>
/* ----------------- 1. 移动端抽屉逻辑 (Bottom Sheet) ----------------- */
const panel = document.getElementById('controlPanel');
const handle = document.getElementById('dragHandle');
const backdrop = document.getElementById('backdrop');

let startY = 0;
let currentY = 0;
let isDragging = false;
let isOpen = false; 

// 仅在移动端初始化
function initMobileSheet() {
    if (window.innerWidth > 655) {
        panel.style.transform = '';
        return;
    }
    
    // 初始化收起状态
    togglePanel(false);
}

// 切换面板状态
function togglePanel(open) {
    isOpen = open;
    if (window.innerWidth > 655) return; // 桌面端不处理

    if (open) {
        panel.style.transform = `translateY(0px)`;
        backdrop.style.opacity = '1';
        backdrop.style.pointerEvents = 'auto';
    } else {
        // 计算收起位置：总高度 - 把手高度(44px)
        const offset = panel.offsetHeight - 44;
        panel.style.transform = `translateY(${offset}px)`;
        backdrop.style.opacity = '0';
        backdrop.style.pointerEvents = 'none';
    }
}

// 绑定触摸事件
handle.addEventListener('click', () => togglePanel(!isOpen));
backdrop.addEventListener('click', () => togglePanel(false)); // 点击背景关闭

handle.addEventListener('touchstart', (e) => {
    isDragging = true;
    startY = e.touches[0].clientY;
    panel.style.transition = 'none'; // 拖拽时移除动画
}, { passive: true });

handle.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    const currentY = e.touches[0].clientY;
    const deltaY = currentY - startY;
    
    const panelHeight = panel.offsetHeight;
    const closedOffset = panelHeight - 44;
    
    let newTranslateY;

    if (isOpen) {
        // 展开状态下向下拉：deltaY > 0
        newTranslateY = deltaY;
        if (newTranslateY < 0) newTranslateY = 0; // 不能向上拖出
    } else {
        // 收起状态下向上拉：deltaY < 0
        newTranslateY = closedOffset + deltaY;
        if (newTranslateY < 0) newTranslateY = 0; // 防止拖过头
    }
    
    panel.style.transform = `translateY(${newTranslateY}px)`;
}, { passive: true });

handle.addEventListener('touchend', (e) => {
    isDragging = false;
    panel.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)'; // 恢复回弹动画
    
    const endY = e.changedTouches[0].clientY;
    const distance = endY - startY;
    
    // 判定逻辑：移动超过 50px 则切换状态
    if (Math.abs(distance) > 50) {
        if (distance > 0) togglePanel(false); // 向下 -> 关闭
        else togglePanel(true); // 向上 -> 打开
    } else {
        togglePanel(isOpen); // 回弹
    }
});

// 监听窗口大小变化（处理横竖屏切换）
window.addEventListener('resize', initMobileSheet);
// 页面加载后延迟初始化，确保高度计算正确
setTimeout(initMobileSheet, 100);


/* ----------------- 2. 视差与交互 ----------------- */
document.addEventListener('mousemove', (e) => {
    const x = (e.clientX / window.innerWidth) * 2 - 1;
    const y = (e.clientY / window.innerHeight) * 2 - 1;
    document.documentElement.style.setProperty('--mx', x.toFixed(2));
    document.documentElement.style.setProperty('--my', y.toFixed(2));
});

/* ----------------- 3. 工具函数 ----------------- */
function hexToHSL(hex) {
    hex = hex.replace("#", "");
    const r = parseInt(hex.substring(0,2),16) / 255;
    const g = parseInt(hex.substring(2,4),16) / 255;
    const b = parseInt(hex.substring(4,6),16) / 255;
    const max = Math.max(r,g,b), min = Math.min(r,g,b);
    let h, s, l = (max + min) / 2;
    if(max === min){ h = s = 0; }
    else {
        const d = max - min;
        s = l > .5 ? d / (2 - max - min) : d / (max + min);
        switch(max){
            case r: h = ((g - b) / d + (g < b ? 6:0)); break;
            case g: h = ((b - r) / d + 2); break;
            case b: h = ((r - g) / d + 4); break;
        }
        h *= 60;
    }
    return { h, s: s*100, l: l*100 };
}

function rr(a,b){ return a + Math.random()*(b-a); }

/* ----------------- 4. 核心生成逻辑 ----------------- */
function generateBlobGradient(baseH1, baseH2, useDual, hueVariance) {
    const layers = Math.floor(rr(3, 6)); 
    let gradients = [];

    // 线性底色
    let bgGradient;
    if(useDual) {
        bgGradient = `linear-gradient(135deg, hsl(${baseH1.h}, ${baseH1.s}%, 90%) 0%, hsl(${baseH2.h}, ${baseH2.s}%, 85%) 100%)`;
    } else {
        bgGradient = `linear-gradient(135deg, hsl(${baseH1.h}, ${baseH1.s}%, 90%) 0%, hsl(${(baseH1.h+40)%360}, ${baseH1.s}%, 85%) 100%)`;
    }
    gradients.push(bgGradient);

    // 内部光斑
    for(let i=0; i<layers; i++){
        let currentBase;
        if (useDual) {
            currentBase = Math.random() > 0.5 ? baseH1 : baseH2;
        } else {
            currentBase = baseH1;
        }

        const h = (currentBase.h + rr(-hueVariance, hueVariance) + 360) % 360;
        const s = rr(60, 95); 
        const l = rr(50, 80); 
        //const l = rr(60, 90); // 提高光斑亮度范围
        
        const x = rr(0, 100);
        const y = rr(0, 100);
        const size = rr(40, 80);
        const opacity = rr(0.5, 0.9);

        gradients.push(
            `radial-gradient(circle at ${x}% ${y}%, hsl(${h},${s}%,${l}% ,${opacity}) 0%, transparent ${size}%)`
        );
    }
    
    return gradients.reverse().join(","); 
}

/* ----------------- 5. 复制与渲染 ----------------- */
function copyToClipboard(div, gradient) {
    const cssCode = `
background: ${gradient};
border-radius: ${getComputedStyle(div).borderRadius};
box-shadow: inset -5px -5px 20px rgba(0,0,0,0.1), inset 5px 5px 20px rgba(255,255,255,0.4);
    `.trim();

    navigator.clipboard.writeText(cssCode).then(() => {
        const toast = document.getElementById("toast");
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2000);
    });
}

function renderAll() {
    const hex1 = document.querySelector("#colorPicker1").value;
    const hex2 = document.querySelector("#colorPicker2").value;
    const useDual = document.querySelector("#dualColorToggle").checked;
    const baseH1 = hexToHSL(hex1);
    const baseH2 = hexToHSL(hex2);
    const hueVariance = parseInt(document.querySelector("#varianceRange").value);
    const size = document.querySelector("#sizeRange").value;
    
    document.querySelector("#grid").style.setProperty('--blob-size', size + 'px');
    document.querySelector("#sizeVal").textContent = size + 'px';

    const grid = document.querySelector("#grid");
    grid.innerHTML = "";
    
    for(let i=0; i<12; i++){
        const div = document.createElement("div");
        div.className = "blob";
        const bgStyle = generateBlobGradient(baseH1, baseH2, useDual, hueVariance);
        div.style.background = bgStyle;
        div.onclick = () => copyToClipboard(div, bgStyle);

        const spinTime = rr(5, 15) + 's';
        div.style.animation = `spin ${spinTime} linear infinite`;
        grid.appendChild(div);
    }
}

/* ----------------- 6. 其他事件监听 ----------------- */
document.querySelector("#dualColorToggle").addEventListener("change", (e) => {
    const wrapper = document.querySelector("#colorInput2Wrapper");
    if(e.target.checked) wrapper.classList.remove("hidden");
    else wrapper.classList.add("hidden");
    
    // 如果在手机端展开状态下切换，重新计算高度以调整位置
    if(window.innerWidth <= 655 && isOpen) {
        setTimeout(() => togglePanel(true), 300); // 等待过渡动画
    }
    renderAll();
});

document.querySelector("#colorPicker1").addEventListener("change", renderAll);
document.querySelector("#colorPicker2").addEventListener("change", renderAll);
document.querySelector("#varianceRange").addEventListener("change", renderAll);
document.querySelector("#sizeRange").addEventListener("input", (e) => {
    document.querySelector("#sizeVal").textContent = e.target.value + 'px';
    document.querySelector("#grid").style.setProperty('--blob-size', e.target.value + 'px');
});

document.querySelector("#diffusionToggle").addEventListener("change", (e) => {
    const grid = document.querySelector("#grid");
    if(e.target.checked) grid.classList.add("diffusion-active");
    else grid.classList.remove("diffusion-active");
});

document.querySelector("#darkModeToggle").addEventListener("change", (e) => {
    if(e.target.checked) document.body.classList.add("dark-mode");
    else document.body.classList.remove("dark-mode");
});

function regenerate(){ renderAll(); }

// 初始化
renderAll();

</script>
</body>
</html>
